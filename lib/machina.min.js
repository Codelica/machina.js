/**
 * machina - A library for creating powerful and flexible finite state machines.  Loosely inspired by Erlang/OTP's gen_fsm behavior.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.4.0-rc1
 * Url: http://machina-js.org/
 * License(s): MIT, GPL
 */
(function(t,e){"object"==typeof module&&module.exports?module.exports=function(){return e(require("lodash"),require("monologue.js"),require("riveter"))}:"function"==typeof define&&define.amd?define(["lodash","monologue","riveter"],function(i,n,r){return e(i,n,r,t)}):t.machina=e(t._,t.Monologue,t.riveter,t)})(this,function(t,e,i,n,r){var a=[].slice,s="transition",o="handler",l="handling",u="handled",c="nohandler",h="transition",d="invalidstate",p="deferred",f="newfsm",g={makeFsmNamespace:function(){var t=0;return function(){return"fsm."+t++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",states:{},namespace:g.makeFsmNamespace()}},getDefaultClientMeta:function(){return{currentAction:r,currentActionArgs:r,inExitHandler:!1,inputQueue:[],priorState:r,priorAction:r,state:r,targetReplayState:r,registered:!0}}},m=function(t,e,i){var n=t.getClientMeta(e);t.emit(u,i),n.priorAction=n.currentAction,n.currentAction="",BehavioralFsm.prototype.processQueue.call(t,n.id,o)},v=function(t,e){var i=t.getClientMeta(e),n=i.state;t.states[n]&&t.states[n]._onExit&&(t.inExitHandler=!0,t.states[n]._onExit.call(t,e,i),t.inExitHandler=!1)},y=function(t,e,i){var n=t.getClientMeta(e);t.states[i]._onEnter&&t.states[i]._onEnter.call(t,e,n),n.targetReplayState===i&&BehavioralFsm.prototype.processQueue.call(t,n.id,s)},C=function(t,e,i){var n=t.getClientMeta(e);n.targetReplayState=i,n.priorState=n.state,n.state=i,t.emit(h,{clientId:n.id,fromState:n.priorState,action:n.currentAction,toState:i})},A=function(t,e,i,n){var r={state:n,clientId:e,inputType:i,type:c};t.emit(c,r)},x=function(t,e,i){var n,r=t.getClientMeta(i),a=t.states,s=r.state,o=a[s][e]?e:"*";return a[s][e]||a[s]["*"]||t["*"]?n={inputType:e,name:o,catchAll:"*"===o,handler:a[s][o]||t["*"],action:a[s][o]?o:"*"}:A(t,r.id,e,s),n},M=function(t,e,i,n){var a=(t.states,"string"==typeof n.handler?n.handler:r),s=t.getClientMeta(e);if(s.currentAction=n.action,t.emit(l,{clientId:s.id,inputType:n.inputType,args:i.slice(1)}),"function"==typeof n.handler){var o=i.slice(n.catchAll?1:2).concat([e,s]);s.currentActionArgs=i;var u=t.deferUntilTransition,c=t.deferUntilNextHandler;t.deferUntilTransition=s.deferUntilTransition,t.deferUntilNextHandler=s.deferUntilNextHandler,a=n.handler.apply(t,o),t.deferUntilTransition=u,t.deferUntilNextHandler=c,s.currentActionArgs=r}a&&BehavioralFsm.prototype.transition.call(t,s.id,a)};BehavioralFsm=function(e){t.merge(this,e),t.defaults(this,g.getDefaultOptions()),this.initialize.apply(this,arguments),S.emit(f,this)},t.extend(BehavioralFsm.prototype,{initialize:function(){},getClient:function(){throw new Error("You need to tell this FSM how to get a client instance by providing a getClient implementation.")},getClientMeta:function(t){return t.__machina?t.__machina:t.__machina={}},register:function(e,i){var n=this.getClientMeta(i);n=t.defaults(this.getClientMeta(i),{deferUntilTransition:this.deferUntilTransition.bind(this,e),deferUntilNextHandler:this.deferUntilNextHandler.bind(this,e),id:e},g.getDefaultClientMeta()),this.initialState&&!n.state&&BehavioralFsm.prototype.transition.call(this,e,this.initialState)},start:function(t){this.register(t,this.getClient(t))},handle:function(t,e){var i,n=this.getClient(t),r=a.call(arguments,0),s=this.getClientMeta(n);if(!n)throw new Error("Could not find client id: "+t+".");(!s||s&&!s.registered)&&this.register(t,n),!s.inExitHandler&&(i=x(this,e,n))&&(M(this,n,r,i),m(this,n,{clientId:t,inputType:e,args:r.slice(2)}))},transition:function(t,e){var i,n=this.getClient(t),r=this.getClientMeta(n);if(!n)throw new Error("Could not find client id: "+t+".");r.registered||this.register(t,n);r.state;r.inExitHandler||e===r.state||(this.states[e]?(v(this,n),C(this,n,e),y(this,n,e)):(i={state:r.state,attemptedState:e},this.emit.call(this,d,i)))},processQueue:function(e,i){var n=this.getClient(e),r=this.getClientMeta(n),a=i===s?function(t){return t.type===s&&(!t.untilState||t.untilState===r.state)}:function(t){return t.type===o},l=t.filter(r.inputQueue,a);r.inputQueue=t.difference(r.inputQueue,l),t.each(l,function(t){BehavioralFsm.prototype.handle.apply(this,t.args)},this)},clearQueue:function(e,i,n){var r="object"!=typeof e?this.getClient(e):e,a=this.getClientMeta(r);if(i){var l;i===s?l=function(t){return t.type===s&&(n?t.untilState===n:!0)}:i===o&&(l=function(t){return t.type===o}),a.inputQueue=t.filter(a.inputQueue,l)}else a.inputQueue=[]},deferUntilTransition:function(t,e){var i=this.getClient(t),n=this.getClientMeta(i),r={type:s,untilState:e,args:n.currentActionArgs};n.inputQueue.push(r),this.emit(p,{clientId:n.id,state:n.state,queuedArgs:r})},deferUntilNextHandler:function(t){var e=this.getClient(t),i=this.getClientMeta(e);if(i.currentActionArgs){var n={type:o,args:i.currentActionArgs};i.inputQueue.push(n),this.emit(p,{state:i.state,queuedArgs:n})}}}),i(BehavioralFsm),BehavioralFsm.inherits(e);var F=BehavioralFsm.extend({constructor:function(){F.prototype.constructor.__super.apply(this,arguments);var e=this.namespace;t.each(["handle","transition","processQueue","clearQueue","deferUntilTransition","deferUntilNextHandler"],function(t){this[t]=this[t].bind(this,e)},this),BehavioralFsm.prototype.register.call(this,e,this)},getClient:function(){return this},getClientMeta:function(){return this}},{},{deep:!0}),S=t.extend({BehavioralFsm:BehavioralFsm,Fsm:F,utils:g},e.prototype);return S});