/**
 * machina - A library for creating powerful and flexible finite state machines.  Loosely inspired by Erlang/OTP's gen_fsm behavior.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.3.6
 * Url: http://machina-js.org/
 * License(s): MIT, GPL
 */
(function(t,e){"object"==typeof module&&module.exports?module.exports=function(){return e(require("lodash"),require("monologue.js"),require("riveter"))}:"function"==typeof define&&define.amd?define(["lodash","monologue","riveter"],function(i,n,r){return e(i,n,r,t)}):t.machina=e(t._,t.Monologue,t.riveter,t)})(this,function(t,e,i,n,r){var a=[].slice,s="transition",o="handler",u="handling",l="handled",c="nohandler",h="transition",p="invalidstate",d="deferred",f="newfsm",m={makeFsmNamespace:function(){var t=0;return function(){return"fsm."+t++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",states:{},namespace:m.makeFsmNamespace()}},getDefaultClientMeta:function(){return{currentAction:r,currentActionArgs:r,inExitHandler:!1,inputQueue:[],priorState:r,priorAction:r,state:r,targetReplayState:r}}},g=function(t,e,i){t.emit(l,i),e.priorAction=e.currentAction,e.currentAction="",BehavioralFsm.prototype.processQueue.call(t,e.id,o)},v=function(t,e){var i=e.state;t.states[i]&&t.states[i]._onExit&&(t.inExitHandler=!0,t.states[i]._onExit.call(t,e.getState(),e),t.inExitHandler=!1)},y=function(t,e,i){t.states[i]._onEnter&&t.states[i]._onEnter.call(t,e.getState(),e),e.targetReplayState===i&&BehavioralFsm.prototype.processQueue.call(t,e.id,s)},A=function(t,e,i){e.targetReplayState=i,e.priorState=e.state,e.state=i,t.emit(h,{clientId:e.id,fromState:e.priorState,action:e.currentAction,toState:i})},S=function(t,e,i,n){var r={state:n,clientId:e,inputType:i,type:c};t.emit(c,r)},x=function(t,e,i){var n,r=t.states,a=i.state,s=r[a][e]?e:"*";return r[a][e]||r[a]["*"]||t["*"]?n={inputType:e,name:s,catchAll:"*"===s,handler:r[a][s]||t["*"],action:r[a][s]?s:"*"}:S(t,i.id,e,a),n},F=function(t,e,i,n){var a,s=(t.states,"string"==typeof n.handler?n.handler:r);if(e.currentAction=n.action,t.emit(u,{clientId:e.id,inputType:n.inputType,args:i.slice(1)}),"function"==typeof n.handler){a=e.getState();var o=i.slice(n.catchAll?1:2).concat([a,e]);e.currentActionArgs=i,s=n.handler.apply(t,o),e.currentActionArgs=r}s&&BehavioralFsm.prototype.transition.call(t,e.id,s)};BehavioralFsm=function(e){t.extend(this,{clients:{}},e),t.defaults(this,m.getDefaultOptions()),this.initialize.apply(this,arguments),B.emit(f,this)},t.extend(BehavioralFsm.prototype,{initialize:function(){},register:function(e,i,n){n=n||{};var r,a="function"==typeof i?i:function(){return i};this.clients[e]||(r=this.clients[e]=t.defaults(n.clientMeta||{},{getState:a,deferUntilTransition:this.deferUntilTransition.bind(this,e),deferUntilNextHandler:this.deferUntilNextHandler.bind(this,e),id:e},m.getDefaultClientMeta()),n.doNotStart||r.state||!this.initialState||this.transition(e,this.initialState))},unregister:function(t){delete this.clients[t]},handle:function(t,e){var i,n=this.clients[t],r=a.call(arguments,0);if(!n)throw new Error("Client id: "+t+" has not been registered with this FSM.");!n.inExitHandler&&(i=x(this,e,n))&&(F(this,n,r,i),g(this,n,{clientId:t,inputType:e,args:r.slice(2)}))},transition:function(t,e){{var i,n=this.clients[t];n.state}n.inExitHandler||e===n.state||(this.states[e]?(v(this,n),A(this,n,e),y(this,n,e)):(i={state:this.state,attemptedState:e},this.emit.call(this,p,i)))},processQueue:function(e,i){var n=this.clients[e],r=i===s?function(t){return t.type===s&&(!t.untilState||t.untilState===n.state)}:function(t){return t.type===o},a=t.filter(n.inputQueue,r);n.inputQueue=t.difference(n.inputQueue,a),t.each(a,function(t){BehavioralFsm.prototype.handle.apply(this,t.args)},this)},clearQueue:function(e,i,n){var r="object"!=typeof e?this.clients[e]:e;if(i){var a;i===s?a=function(t){return t.type===s&&(n?t.untilState===n:!0)}:i===o&&(a=function(t){return t.type===o}),r.inputQueue=t.filter(r.inputQueue,a)}else r.inputQueue=[]},deferUntilTransition:function(t,e){var i=this.clients[t];if(i.currentActionArgs){var n={type:s,untilState:e,args:i.currentActionArgs};i.inputQueue.push(n),this.emit(d,{clientId:i.id,state:i.state,queuedArgs:n})}},deferUntilNextHandler:function(t){var e=this.clients[t];if(e.currentActionArgs){var i={type:o,args:e.currentActionArgs};e.inputQueue.push(i),this.emit(d,{state:e.state,queuedArgs:i})}}}),i(BehavioralFsm),BehavioralFsm.inherits(e);var Q=BehavioralFsm.extend({constructor:function(){Q.prototype.constructor.__super.apply(this,arguments);var e=this.namespace;this.register(e,function(){return this},{clientMeta:this,doNotStart:!0}),t.each(["handle","transition","processQueue","clearQueue","deferUntilTransition","deferUntilNextHandler"],function(t){this[t]=this[t].bind(this,e)},this),this.initialState&&this.transition(this.initialState)}},{},{deep:!0}),B=t.extend({BehavioralFsm:BehavioralFsm,Fsm:Q,utils:m},e.prototype);return B});