/**
 * machina - A library for creating powerful and flexible finite state machines.  Loosely inspired by Erlang/OTP's gen_fsm behavior.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.4.0-rc1
 * Url: http://machina-js.org/
 * License(s): MIT, GPL
 */
(function(t,e){"object"==typeof module&&module.exports?module.exports=function(){return e(require("lodash"),require("monologue.js"),require("riveter"))}:"function"==typeof define&&define.amd?define(["lodash","monologue","riveter"],function(i,n,a){return e(i,n,a,t)}):t.machina=e(t._,t.Monologue,t.riveter,t)})(this,function(t,e,i,n,a){var r=[].slice,s="transition",c="handler",o="handling",l="handled",u="nohandler",h="transition",_="invalidstate",m="deferred",d="newfsm",f={makeFsmNamespace:function(){var t=0;return function(){return"fsm."+t++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",states:{},namespace:f.makeFsmNamespace()}},getDefaultClientMeta:function(){return{currentAction:a,currentActionArgs:a,inExitHandler:!1,inputQueue:[],priorState:a,priorAction:a,state:a,targetReplayState:a,registered:!0}}},p=function(t,e,i){t.emit(l,i),e.__machina.priorAction=e.__machina.currentAction,e.__machina.currentAction="",BehavioralFsm.prototype.processQueue.call(t,e.__machina.id,c)},g=function(t,e){var i=e.__machina.state;t.states[i]&&t.states[i]._onExit&&(t.inExitHandler=!0,t.states[i]._onExit.call(t,e),t.inExitHandler=!1)},v=function(t,e,i){t.states[i]._onEnter&&t.states[i]._onEnter.call(t,e),e.__machina.targetReplayState===i&&BehavioralFsm.prototype.processQueue.call(t,e.__machina.id,s)},y=function(t,e,i){e.__machina.targetReplayState=i,e.__machina.priorState=e.__machina.state,e.__machina.state=i,t.emit(h,{clientId:e.__machina.id,fromState:e.__machina.priorState,action:e.__machina.currentAction,toState:i})},A=function(t,e,i,n){var a={state:n,clientId:e,inputType:i,type:u};t.emit(u,a)},x=function(t,e,i){var n,a=t.states,r=i.__machina.state,s=a[r][e]?e:"*";return a[r][e]||a[r]["*"]||t["*"]?n={inputType:e,name:s,catchAll:"*"===s,handler:a[r][s]||t["*"],action:a[r][s]?s:"*"}:A(t,i.__machina.id,e,r),n},S=function(t,e,i,n){var r=(t.states,"string"==typeof n.handler?n.handler:a);if(e.__machina.currentAction=n.action,t.emit(o,{clientId:e.__machina.id,inputType:n.inputType,args:i.slice(1)}),"function"==typeof n.handler){var s=i.slice(n.catchAll?1:2).concat([e]);e.__machina.currentActionArgs=i;var c=t.deferUntilTransition,l=t.deferUntilNextHandler;t.deferUntilTransition=e.__machina.deferUntilTransition,t.deferUntilNextHandler=e.__machina.deferUntilNextHandler,r=n.handler.apply(t,s),t.deferUntilTransition=c,t.deferUntilNextHandler=l,e.__machina.currentActionArgs=a}r&&BehavioralFsm.prototype.transition.call(t,e.__machina.id,r)};BehavioralFsm=function(e){t.merge(this,e),t.defaults(this,f.getDefaultOptions()),this.initialize.apply(this,arguments),U.emit(d,this)},t.extend(BehavioralFsm.prototype,{initialize:function(){},getClient:function(){throw new Error("You need to tell this FSM how to get a client instance by providing a getClient implementation.")},getClientMeta:function(t){return t.__machina?t.__machina:t.__machina={}},register:function(e,i){var n=this.getClientMeta(i);n=t.defaults(this.getClientMeta(i),{deferUntilTransition:this.deferUntilTransition.bind(this,e),deferUntilNextHandler:this.deferUntilNextHandler.bind(this,e),id:e},f.getDefaultClientMeta()),this.initialState&&!n.state&&this.transition(e,this.initialState)},start:function(t){this.register(t,this.getClient(t))},handle:function(t,e){var i,n=this.getClient(t),a=r.call(arguments,0),s=this.getClientMeta(n);if(!n)throw new Error("Could not find client id: "+t+".");(!s||s&&!s.registered)&&this.register(t,n),!s.inExitHandler&&(i=x(this,e,n))&&(S(this,n,a,i),p(this,n,{clientId:t,inputType:e,args:a.slice(2)}))},transition:function(t,e){var i,n=this.getClient(t);if(!n)throw new Error("Could not find client id: "+t+".");(!n.__machina||n.__machina&&!n.__machina.registered)&&this.register(t,n);n.__machina.state;n.__machina.inExitHandler||e===n.__machina.state||(this.states[e]?(g(this,n),y(this,n,e),v(this,n,e)):(i={state:n.__machina.state,attemptedState:e},this.emit.call(this,_,i)))},processQueue:function(e,i){var n=this.getClient(e),a=i===s?function(t){return t.type===s&&(!t.untilState||t.untilState===n.__machina.state)}:function(t){return t.type===c},r=t.filter(n.__machina.inputQueue,a);n.__machina.inputQueue=t.difference(n.__machina.inputQueue,r),t.each(r,function(t){BehavioralFsm.prototype.handle.apply(this,t.args)},this)},clearQueue:function(e,i,n){var a="object"!=typeof e?this.getClient(e):e;if(i){var r;i===s?r=function(t){return t.type===s&&(n?t.untilState===n:!0)}:i===c&&(r=function(t){return t.type===c}),a.__machina.inputQueue=t.filter(a.__machina.inputQueue,r)}else a.__machina.inputQueue=[]},deferUntilTransition:function(t,e){var i=this.getClient(t),n={type:s,untilState:e,args:i.__machina.currentActionArgs};i.__machina.inputQueue.push(n),this.emit(m,{clientId:i.__machina.id,state:i.__machina.state,queuedArgs:n})},deferUntilNextHandler:function(t){var e=this.getClient(t);if(e.__machina.currentActionArgs){var i={type:c,args:e.__machina.currentActionArgs};e.__machina.inputQueue.push(i),this.emit(m,{state:e.__machina.state,queuedArgs:i})}}}),i(BehavioralFsm),BehavioralFsm.inherits(e);var C=BehavioralFsm.extend({constructor:function(){C.prototype.constructor.__super.apply(this,arguments);var e=this.namespace;this.__machina=this,t.each(["handle","transition","processQueue","clearQueue","deferUntilTransition","deferUntilNextHandler"],function(t){this[t]=this[t].bind(this,e)},this),this.initialState&&this.transition(this.initialState)},getClient:function(){return this}},{},{deep:!0}),U=t.extend({BehavioralFsm:BehavioralFsm,Fsm:C,utils:f},e.prototype);return U});